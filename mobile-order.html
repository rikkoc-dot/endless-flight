<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<!--
  ============================================================
  CSP: ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã¯ã‚µãƒ¼ãƒãƒ¼å´ãƒ˜ãƒƒãƒ€ãƒ¼ã§ã®è¨­å®šã‚’æ¨å¥¨
  Firebase Hosting ã®å ´åˆ â†’ firebase.json ã® headers ã«è¿½è¨˜:
  {
    "headers": [{
      "source": "**",
      "headers": [{
        "key": "Content-Security-Policy",
        "value": "default-src 'self' https://*.firebaseio.com https://*.googleapis.com https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src https://*.firebaseio.com wss://*.firebaseio.com https://*.googleapis.com"
      }]
    }]
  }
  ============================================================
-->
<title>ãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼ | ä¹ƒæœ¨å‚46</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Cormorant+Garamond:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script type="module">
  import { initializeApp }        from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, push, set }
                                  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // ============================================================
  // ğŸ”¥ FIREBASE CONFIG
  // Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ« â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š â†’ ãƒã‚¤ã‚¢ãƒ—ãƒª ã‹ã‚‰å–å¾—
  //
  // âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼ˆå¿…é ˆï¼‰:
  //   Firebase Console â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š â†’ å…¨èˆ¬ â†’ ã€ŒAPIã‚­ãƒ¼ã‚’åˆ¶é™ã€
  //   â†’ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆ¶é™ï¼šHTTPãƒªãƒ•ã‚¡ãƒ©ãƒ¼
  //   â†’ https://yourdomain.com/* ã®ã¿è¨±å¯ã™ã‚‹ã“ã¨
  // ============================================================
  const firebaseConfig = {
    apiKey:            "YOUR_API_KEY",
    authDomain:        "YOUR_PROJECT_ID.firebaseapp.com",
    databaseURL:       "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
    projectId:         "YOUR_PROJECT_ID",
    storageBucket:     "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId:             "YOUR_APP_ID"
  };

  // ============================================================
  // Firebase Security Rulesï¼ˆRealtime Databaseï¼‰
  // Firebase Console â†’ Realtime Database â†’ ãƒ«ãƒ¼ãƒ« ã«ä»¥ä¸‹ã‚’è¨­å®š:
  // {
  //   "rules": {
  //     "settings":  { ".read": true,  ".write": "auth != null" },
  //     "products":  { ".read": true,  ".write": "auth != null" },
  //     "orders":    { ".read": "auth != null", ".write": true  },
  //     "$other":    { ".read": false, ".write": false }
  //   }
  // }
  // â€» $other ã§æœªå®šç¾©ãƒ‘ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ˜ç¤ºçš„ã«æ‹’å¦
  // â€» orders ã¯èª°ã§ã‚‚æ›¸ãè¾¼ã¿å¯ï¼ˆæ³¨æ–‡ä¿å­˜ç”¨ï¼‰ã€èª­ã¿å–ã‚Šã¯ç®¡ç†è€…ã®ã¿
  // ============================================================

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // Firebaseã®åˆæœŸåŒ–ãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
  function initFirebase() {
    // è¨­å®šï¼ˆå¾…ã¡æ™‚é–“ãƒ»è²©å£²çŠ¶æ³ãƒ»ãŠçŸ¥ã‚‰ã›ï¼‰
    onValue(ref(db, 'settings'), (snapshot) => {
      const s = snapshot.val();
      if (!s) return;

      const wtEl = document.getElementById('wait-time');
      if (wtEl) wtEl.textContent = s.waitTime ?? '--';

      const stEl = document.getElementById('sale-start-time');
      if (stEl) stEl.textContent = s.saleStartTime ?? '--:--';

      const eyebrow  = document.getElementById('hero-eyebrow-text');
      const heroEye  = document.getElementById('hero-eyebrow');
      const orderBtn = document.getElementById('order-btn');

      if (s.isOpen === false) {
        if (eyebrow)  eyebrow.textContent = 'è²©å£²çµ‚äº†';
        if (heroEye)  { heroEye.style.background = '#f5f5f5'; heroEye.style.borderColor = '#ddd'; heroEye.style.color = '#999'; }
        if (orderBtn) { orderBtn.textContent = 'ç¾åœ¨è²©å£²ã—ã¦ãŠã‚Šã¾ã›ã‚“'; orderBtn.disabled = true; orderBtn.style.opacity = '0.5'; }
        document.getElementById('hero-dot')?.remove();
      } else {
        if (eyebrow)  eyebrow.textContent = 'è²©å£²ä¸­';
        if (orderBtn) { orderBtn.textContent = 'å•†å“ã‚’è¦‹ã‚‹ â†’'; orderBtn.disabled = false; orderBtn.style.opacity = '1'; }
      }

      // ãŠçŸ¥ã‚‰ã›ï¼ˆtextContent ã§ XSS ã‚’é˜²ãï¼‰
      const noticeEl = document.getElementById('sale-notice');
      if (noticeEl) {
        if (s.saleMessage) {
          noticeEl.textContent = s.saleMessage; // â† innerHTML ã§ã¯ãªã textContent
          noticeEl.style.display = 'block';
        } else {
          noticeEl.style.display = 'none';
        }
      }
    });

    // å•†å“åœ¨åº«çŠ¶æ³
    onValue(ref(db, 'products'), (snapshot) => {
      const data = snapshot.val();
      if (!data) return;
      Object.keys(data).forEach(id => {
        const idx = PRODUCTS.findIndex(p => p.id === Number(id));
        if (idx !== -1 && typeof data[id].soldOut === 'boolean') {
          PRODUCTS[idx].soldOut = data[id].soldOut;
        }
      });
      renderProducts();
    });
  }

  // ============================================================
  // æ³¨æ–‡ã‚’ Firebase ã«ä¿å­˜ã—ã¦ orderId ã®ã¿è¿”ã™ï¼ˆ#6 å¯¾å‡¦ï¼‰
  // orders/{orderId}/itemsãƒ»total ã‚’ä¿å­˜
  // QRã«ã¯ orderId ã ã‘ã‚’åŸ‹ã‚è¾¼ã‚€ â†’ ãƒ¬ã‚¸å´ã§ç…§åˆ
  // ============================================================
  window.saveOrderToFirebase = async (orderData) => {
    try {
      const orderRef = push(ref(db, 'orders'));
      await set(orderRef, {
        ...orderData,
        createdAt: new Date().toISOString(),
        status: 'pending'
      });
      return orderRef.key; // Firebase ãŒè‡ªå‹•ç”Ÿæˆã—ãŸã‚­ãƒ¼ã‚’è¿”ã™
    } catch (e) {
      console.error('Order save failed:', e);
      return null;
    }
  };

  window.addEventListener('DOMContentLoaded', () => {
    if (firebaseConfig.apiKey === 'YOUR_API_KEY') {
      console.warn('[Firebase] æœªè¨­å®š â€” ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™');
      document.getElementById('firebase-warning').style.display = 'flex';
    } else {
      initFirebase();
    }
  });
</script>

<style>
  :root {
    --primary: #c0003c;
    --primary-light: #e8003d;
    --primary-pale: #fff0f3;
    --bg: #fafaf9;
    --surface: #ffffff;
    --surface2: #f5f4f2;
    --border: #e8e4df;
    --border-strong: #d5cfc9;
    --text: #1a1714;
    --text-muted: #8a847e;
    --text-light: #b5afa9;
    --shadow: rgba(26,23,20,0.07);
    --shadow-md: rgba(26,23,20,0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100dvh; max-width: 480px;
    margin: 0 auto; overflow-x: hidden;
  }

  #firebase-warning {
    display: none; align-items: center; gap: 10px;
    background: #fffbec; border-bottom: 1px solid #f0d060;
    padding: 10px 16px; font-size: 11px; color: #7a6000;
    position: sticky; top: 0; z-index: 200;
  }

  .header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(250,250,249,0.95);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 18px; height: 58px;
    display: flex; align-items: center; justify-content: space-between;
  }

  .header-logo-main {
    font-family: 'Cormorant Garamond', serif;
    font-size: 15px; font-weight: 600; letter-spacing: 3px;
    color: var(--primary); text-transform: uppercase;
  }

  .header-logo-sub {
    font-size: 9px; letter-spacing: 1.5px;
    color: var(--text-muted); text-transform: uppercase; margin-top: 1px;
  }

  .header-event { font-size: 10px; color: var(--text-muted); line-height: 1.4; text-align: right; }
  .header-event strong { display: block; font-size: 11px; color: var(--text); font-weight: 700; }

  .bottom-nav {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: 480px;
    background: rgba(255,255,255,0.97); backdrop-filter: blur(20px);
    border-top: 1px solid var(--border); display: flex; z-index: 100;
    box-shadow: 0 -4px 20px var(--shadow);
  }

  .nav-item {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 3px; padding: 10px 4px 14px;
    cursor: pointer; color: var(--text-light);
    font-size: 9px; letter-spacing: 0.8px; text-transform: uppercase;
    transition: color 0.2s; position: relative;
    border: none; background: none; font-family: 'Noto Sans JP', sans-serif;
  }

  .nav-item.active { color: var(--primary); }
  .nav-item.active::before {
    content: ''; position: absolute; top: 0; left: 50%;
    transform: translateX(-50%); width: 28px; height: 2px;
    background: var(--primary); border-radius: 0 0 2px 2px;
  }

  .nav-icon { font-size: 20px; line-height: 1; }

  .cart-badge {
    position: absolute; top: 7px; left: 50%; margin-left: 4px;
    background: var(--primary); color: #fff; font-size: 9px; font-weight: 700;
    width: 16px; height: 16px; border-radius: 50%;
    display: none; align-items: center; justify-content: center;
  }

  .page { display: none; padding: 20px 18px 92px; animation: fadeIn 0.22s ease; }
  .page.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  /* TOP */
  .hero {
    background: linear-gradient(150deg, #fff 0%, #fff8f9 60%, #fff0f3 100%);
    border: 1px solid var(--border); border-radius: 20px;
    padding: 24px; margin-bottom: 22px;
    box-shadow: 0 2px 16px var(--shadow); position: relative; overflow: hidden;
  }

  .hero::after {
    content: ''; position: absolute; bottom: -40px; right: -40px;
    width: 140px; height: 140px;
    background: radial-gradient(circle, rgba(192,0,60,0.07) 0%, transparent 70%);
    pointer-events: none;
  }

  .hero-eyebrow {
    display: inline-flex; align-items: center; gap: 6px;
    background: var(--primary-pale); border: 1px solid rgba(192,0,60,0.15);
    padding: 4px 10px; border-radius: 20px;
    font-size: 10px; color: var(--primary); font-weight: 700; letter-spacing: 1px;
    margin-bottom: 14px; transition: all 0.3s;
  }

  .hero-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--primary); animation: blink 1.5s infinite; }
  @keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.25; } }

  .hero-group { font-size: 11px; color: var(--text-muted); font-weight: 500; margin-bottom: 2px; }
  .hero-title { font-size: 20px; font-weight: 900; line-height: 1.3; margin-bottom: 4px; }
  .hero-date { font-size: 12px; color: var(--text-muted); margin-bottom: 20px; display: flex; align-items: center; gap: 6px; }

  .wait-card {
    background: #fff; border: 1px solid var(--border); border-radius: 14px;
    padding: 14px 18px; display: flex; align-items: center; gap: 14px;
    box-shadow: 0 1px 6px var(--shadow); margin-bottom: 10px;
  }

  .wait-icon { font-size: 26px; }
  .wait-label { font-size: 10px; color: var(--text-muted); font-weight: 500; letter-spacing: 0.5px; margin-bottom: 2px; }
  .wait-row { display: flex; align-items: baseline; gap: 4px; }
  .wait-time { font-family: 'Cormorant Garamond', serif; font-size: 38px; font-weight: 600; color: var(--primary); line-height: 1; }
  .wait-unit { font-size: 12px; color: var(--text-muted); }
  .sale-row { display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-muted); padding: 8px 12px; background: var(--surface2); border-radius: 8px; }

  #sale-notice {
    display: none; background: var(--primary-pale);
    border: 1px solid rgba(192,0,60,0.2); border-radius: 10px;
    padding: 10px 14px; font-size: 12px; color: var(--primary);
    line-height: 1.6; margin-top: 10px;
  }

  .section-label {
    display: flex; align-items: center; gap: 10px;
    font-size: 10px; letter-spacing: 3px; color: var(--text-muted);
    text-transform: uppercase; font-weight: 700; margin-bottom: 14px;
  }
  .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .steps { display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px; }
  .step {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 16px 18px;
    display: flex; align-items: flex-start; gap: 14px;
    box-shadow: 0 1px 4px var(--shadow); transition: box-shadow 0.2s, transform 0.15s;
  }
  .step:hover { box-shadow: 0 4px 16px var(--shadow-md); transform: translateY(-1px); }
  .step-num-wrap {
    min-width: 32px; height: 32px; background: var(--primary-pale);
    border: 1px solid rgba(192,0,60,0.15); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .step-num { font-family: 'Cormorant Garamond', serif; font-size: 16px; font-weight: 600; color: var(--primary); line-height: 1; }
  .step-icon { font-size: 20px; margin-bottom: 4px; }
  .step-title { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
  .step-desc { font-size: 12px; color: var(--text-muted); line-height: 1.6; }

  .btn-primary {
    display: block; width: 100%; background: var(--primary); color: #fff;
    border: none; border-radius: 14px; padding: 17px;
    font-family: 'Noto Sans JP', sans-serif; font-size: 14px; font-weight: 700; letter-spacing: 1.5px;
    cursor: pointer; transition: background 0.2s, transform 0.12s; text-align: center;
    box-shadow: 0 4px 14px rgba(192,0,60,0.22);
  }
  .btn-primary:hover { background: var(--primary-light); }
  .btn-primary:active { transform: scale(0.98); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* PRODUCTS */
  .search-bar {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 11px 16px;
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 14px; box-shadow: 0 1px 4px var(--shadow);
  }
  .search-bar input {
    background: none; border: none; outline: none;
    color: var(--text); font-family: 'Noto Sans JP', sans-serif; font-size: 14px; flex: 1;
  }
  .search-bar input::placeholder { color: var(--text-light); }

  .category-tabs { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; margin-bottom: 18px; padding-bottom: 2px; }
  .category-tabs::-webkit-scrollbar { display: none; }

  .cat-tab {
    white-space: nowrap; padding: 7px 14px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; font-size: 12px; color: var(--text-muted);
    cursor: pointer; transition: all 0.18s; flex-shrink: 0;
    font-family: 'Noto Sans JP', sans-serif; font-weight: 500;
  }
  .cat-tab.active { background: var(--primary); border-color: var(--primary); color: #fff; font-weight: 700; box-shadow: 0 3px 10px rgba(192,0,60,0.2); }

  .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .product-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; overflow: hidden; cursor: pointer;
    transition: box-shadow 0.2s, transform 0.15s;
    position: relative; box-shadow: 0 1px 4px var(--shadow);
  }
  .product-card:hover { box-shadow: 0 6px 20px var(--shadow-md); transform: translateY(-2px); }
  .product-card:active { transform: scale(0.97); }

  .product-img {
    width: 100%; aspect-ratio: 1;
    background: linear-gradient(135deg, #fdf5f7, #f8f0f2);
    display: flex; align-items: center; justify-content: center;
    font-size: 52px; position: relative; overflow: hidden;
  }
  .sold-out-overlay {
    position: absolute; inset: 0; background: rgba(255,255,255,0.78);
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 900; letter-spacing: 3px; color: var(--primary); backdrop-filter: blur(2px);
  }
  .product-info { padding: 10px 12px 14px; }
  .product-name { font-size: 12px; font-weight: 700; line-height: 1.4; margin-bottom: 6px; }
  .product-price { font-family: 'Cormorant Garamond', serif; font-size: 20px; font-weight: 600; color: var(--primary); line-height: 1; }
  .product-price span { font-family: 'Noto Sans JP', sans-serif; font-size: 10px; color: var(--text-light); font-weight: 400; margin-left: 2px; }

  .add-btn {
    position: absolute; bottom: 10px; right: 10px;
    width: 28px; height: 28px; background: var(--primary); border: none; border-radius: 50%;
    color: #fff; font-size: 18px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: transform 0.1s; box-shadow: 0 3px 8px rgba(192,0,60,0.28);
  }
  .add-btn:active { transform: scale(0.88); }

  .in-cart-indicator {
    position: absolute; top: 8px; right: 8px;
    background: var(--primary); color: #fff; font-size: 10px; font-weight: 700;
    padding: 3px 8px; border-radius: 10px; display: none;
    box-shadow: 0 2px 6px rgba(192,0,60,0.3);
  }

  /* CART */
  .cart-empty { text-align: center; padding: 60px 20px; color: var(--text-muted); }
  .cart-empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.25; }

  .cart-item {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 14px; display: flex; gap: 12px; align-items: center;
    margin-bottom: 10px; box-shadow: 0 1px 4px var(--shadow); animation: fadeIn 0.2s ease;
  }
  .cart-item-img {
    width: 60px; height: 60px;
    background: linear-gradient(135deg, #fdf5f7, #f8f0f2);
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-size: 28px; flex-shrink: 0;
  }
  .cart-item-info { flex: 1; }
  .cart-item-name { font-size: 13px; font-weight: 700; margin-bottom: 4px; line-height: 1.3; }
  .cart-item-price { font-family: 'Cormorant Garamond', serif; font-size: 18px; font-weight: 600; color: var(--primary); }
  .qty-control { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
  .qty-btn {
    width: 28px; height: 28px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.15s;
  }
  .qty-btn:active { background: var(--primary); border-color: var(--primary); color: #fff; }
  .qty-num { font-size: 14px; font-weight: 700; min-width: 20px; text-align: center; }
  .delete-btn {
    background: none; border: none; color: var(--text-light);
    font-size: 18px; cursor: pointer; padding: 6px; transition: color 0.15s; border-radius: 8px;
  }
  .delete-btn:hover { color: var(--primary); background: var(--primary-pale); }

  .cart-summary {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 18px; margin-bottom: 16px;
    box-shadow: 0 1px 4px var(--shadow);
  }
  .summary-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 13px; color: var(--text-muted); }
  .summary-row.total { border-top: 1px solid var(--border); margin-top: 10px; padding-top: 14px; font-size: 15px; font-weight: 700; color: var(--text); }
  .summary-row.total .amount { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 600; color: var(--primary); }

  /* QR */
  .qr-header { text-align: center; margin-bottom: 24px; }
  .qr-header h2 { font-family: 'Cormorant Garamond', serif; font-size: 28px; font-weight: 600; letter-spacing: 2px; margin-bottom: 6px; }
  .qr-header p { font-size: 12px; color: var(--text-muted); }

  .qr-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 28px 24px;
    display: flex; flex-direction: column; align-items: center; gap: 18px;
    margin-bottom: 18px; box-shadow: 0 4px 20px var(--shadow-md);
  }
  #qr-container {
    background: #fff; border-radius: 16px; padding: 16px;
    display: flex; align-items: center; justify-content: center;
    width: 200px; height: 200px; border: 1px solid var(--border); box-shadow: 0 2px 10px var(--shadow);
  }
  .qr-divider { width: 100%; height: 1px; background: var(--border); }
  .qr-order-id { font-family: 'Cormorant Garamond', serif; font-size: 15px; letter-spacing: 4px; color: var(--text-muted); }
  .qr-total-wrap { text-align: center; }
  .qr-total-label { font-size: 10px; color: var(--text-muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 4px; }
  .qr-total { font-family: 'Cormorant Garamond', serif; font-size: 38px; font-weight: 600; color: var(--primary); line-height: 1; }

  .qr-saving {
    font-size: 12px; color: var(--text-muted);
    display: flex; align-items: center; gap: 6px; animation: fadeIn 0.3s ease;
  }

  .qr-notice { background: #fffbec; border: 1px solid #f0d060; border-radius: 12px; padding: 14px 16px; font-size: 12px; color: #7a6000; line-height: 1.7; margin-bottom: 14px; }
  .qr-empty { text-align: center; padding: 60px 20px; color: var(--text-muted); }

  .btn-secondary {
    display: block; width: 100%; background: #fff; color: var(--text-muted);
    border: 1px solid var(--border); border-radius: 14px; padding: 15px;
    font-family: 'Noto Sans JP', sans-serif; font-size: 13px; font-weight: 500;
    cursor: pointer; transition: all 0.18s; text-align: center; box-shadow: 0 1px 4px var(--shadow);
  }
  .btn-secondary:hover { background: var(--surface2); }

  /* Toast */
  .toast {
    position: fixed; top: 68px; left: 50%;
    transform: translateX(-50%) translateY(-8px);
    background: var(--text); color: #fff; padding: 10px 20px; border-radius: 20px;
    font-size: 12px; font-weight: 700; z-index: 999; opacity: 0; pointer-events: none;
    transition: all 0.25s; white-space: nowrap; box-shadow: 0 4px 16px rgba(0,0,0,0.18); letter-spacing: 0.5px;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(26,23,20,0.45); z-index: 200;
    display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px);
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface); border-radius: 24px 24px 0 0; padding: 24px;
    width: 100%; max-width: 480px;
    animation: slideUp 0.28s cubic-bezier(.32,.72,0,1); max-height: 85dvh; overflow-y: auto;
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-handle { width: 36px; height: 4px; background: var(--border-strong); border-radius: 2px; margin: 0 auto 20px; }
  .modal-img { width: 100%; aspect-ratio: 1; background: linear-gradient(135deg, #fdf5f7, #f8f0f2); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 80px; margin-bottom: 20px; }
  .modal-name { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
  .modal-price { font-family: 'Cormorant Garamond', serif; font-size: 30px; font-weight: 600; color: var(--primary); margin-bottom: 10px; }
  .modal-desc { font-size: 13px; color: var(--text-muted); line-height: 1.7; margin-bottom: 24px; }
  .modal-qty { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 24px; }
  .modal-qty-btn {
    width: 40px; height: 40px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 12px; color: var(--text); font-size: 20px;
    display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.15s;
  }
  .modal-qty-btn:active { background: var(--primary); color: #fff; border-color: var(--primary); }
  .modal-qty-num { font-size: 22px; font-weight: 700; min-width: 40px; text-align: center; }
</style>
</head>
<body>

<div id="firebase-warning">
  âš ï¸ Firebaseæœªè¨­å®šï¼šãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œä¸­ã§ã™ã€‚<code style="background:#fde;padding:1px 4px;border-radius:3px;font-size:10px;">firebaseConfig</code> ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
</div>

<header class="header">
  <div>
    <div class="header-logo-main">Mobile Order</div>
    <div class="header-logo-sub">Official Merchandise</div>
  </div>
  <div class="header-event">
    <strong>ä¹ƒæœ¨å‚46</strong>
    41st SG ã‚¢ãƒ³ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ–
  </div>
</header>

<div class="toast" id="toast"></div>

<!-- TOP -->
<div class="page active" id="page-top">
  <div class="hero">
    <div class="hero-eyebrow" id="hero-eyebrow">
      <div class="hero-dot" id="hero-dot"></div>
      <span id="hero-eyebrow-text">è²©å£²ä¸­</span>
    </div>
    <div class="hero-group">ä¹ƒæœ¨å‚46</div>
    <div class="hero-title">41stSGã‚¢ãƒ³ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ–</div>
    <div class="hero-date">ğŸ“… 2026.3.17ã€œ19 @ ã´ã‚ã‚¢ãƒªãƒ¼ãƒŠMM</div>
    <div class="wait-card">
      <div class="wait-icon">â±</div>
      <div>
        <div class="wait-label">åªä»Šã®å¾…ã¡æ™‚é–“</div>
        <div class="wait-row">
          <div class="wait-time" id="wait-time">--</div>
          <div class="wait-unit">åˆ†ç¨‹åº¦</div>
        </div>
      </div>
    </div>
    <div class="sale-row">ğŸ• <span>è²©å£²é–‹å§‹ï¼š<strong id="sale-start-time">--:--</strong>ï¼ˆäºˆå®šï¼‰</span></div>
    <div id="sale-notice"></div>
  </div>
  <div class="section-label">How to Use</div>
  <div class="steps">
    <div class="step">
      <div class="step-num-wrap"><div class="step-num">1</div></div>
      <div><div class="step-icon">ğŸ›’</div><div class="step-title">å•†å“ã‚’é¸ã¶</div><div class="step-desc">å•†å“ä¸€è¦§ã‚ˆã‚Šè³¼å…¥å¸Œæœ›ã®å•†å“ã‚’é¸æŠã—ã€ã‚«ãƒ¼ãƒˆã¸è¿½åŠ ã—ã¾ã™</div></div>
    </div>
    <div class="step">
      <div class="step-num-wrap"><div class="step-num">2</div></div>
      <div><div class="step-icon">ğŸ“±</div><div class="step-title">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æç¤º</div><div class="step-desc">è‡ªå‹•ã§QRã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¾ã™ã€‚ãƒ¬ã‚¸ã«ã¦ã”æç¤ºãã ã•ã„</div></div>
    </div>
    <div class="step">
      <div class="step-num-wrap"><div class="step-num">3</div></div>
      <div><div class="step-icon">ğŸ›</div><div class="step-title">å•†å“ã‚’å—ã‘å–ã‚‹</div><div class="step-desc">ã‚¹ã‚¿ãƒƒãƒ•ãŒå•†å“ã‚’ç”¨æ„ã„ãŸã—ã¾ã™ã€‚ãã®å¾Œã«ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™</div></div>
    </div>
  </div>
  <button class="btn-primary" id="order-btn" onclick="navigate('products')">å•†å“ã‚’è¦‹ã‚‹ â†’</button>
</div>

<!-- PRODUCTS -->
<div class="page" id="page-products">
  <div class="search-bar">
    <span style="color:var(--text-light)">ğŸ”</span>
    <input type="text" placeholder="å•†å“ã‚’æ¤œç´¢..." id="search-input" oninput="filterProducts()">
  </div>
  <div class="category-tabs" id="category-tabs"></div>
  <div class="product-grid" id="product-grid"></div>
</div>

<!-- CART -->
<div class="page" id="page-cart">
  <div id="cart-empty" class="cart-empty">
    <div class="cart-empty-icon">ğŸ›’</div>
    <p>ã‚«ãƒ¼ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p>
    <p style="font-size:12px;margin-top:8px;color:var(--text-light);">å•†å“ä¸€è¦§ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</p>
    <button class="btn-primary" style="margin-top:24px;" onclick="navigate('products')">å•†å“ã‚’è¦‹ã‚‹</button>
  </div>
  <div id="cart-content" style="display:none;">
    <div class="cart-items" id="cart-items"></div>
    <div class="cart-summary">
      <div class="summary-row"><span>å°è¨ˆï¼ˆç¨è¾¼ï¼‰</span><span id="subtotal">Â¥0</span></div>
      <div class="summary-row total"><span>ãŠæ”¯æ‰•ã„åˆè¨ˆ</span><div class="amount" id="total-amount">Â¥0</div></div>
    </div>
    <button class="btn-primary" onclick="navigate('qr')">QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ â†’</button>
  </div>
</div>

<!-- QR -->
<div class="page" id="page-qr">
  <div id="qr-empty" class="qr-empty">
    <div style="font-size:64px;opacity:0.2;margin-bottom:16px;">ğŸ“±</div>
    <p>ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
    <button class="btn-primary" style="margin-top:24px;" onclick="navigate('products')">å•†å“ã‚’é¸ã¶</button>
  </div>
  <div id="qr-content" style="display:none;">
    <div class="qr-header">
      <h2>QRã‚³ãƒ¼ãƒ‰ã‚’æç¤º</h2>
      <p>ãƒ¬ã‚¸ã§ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„</p>
    </div>
    <div class="qr-box">
      <div id="qr-container"></div>
      <div class="qr-divider"></div>
      <div class="qr-order-id" id="qr-order-id">ORDER-XXXXXX</div>
      <div class="qr-total-wrap">
        <div class="qr-total-label">ãŠæ”¯æ‰•ã„é‡‘é¡</div>
        <div class="qr-total">Â¥<span id="qr-total-num">0</span></div>
      </div>
      <div id="qr-saving" class="qr-saving" style="display:none;">â³ æ³¨æ–‡ã‚’ç™»éŒ²ä¸­...</div>
    </div>
    <div class="qr-notice">
      âš ï¸ ã“ã®QRã‚³ãƒ¼ãƒ‰ã¯ã”æ³¨æ–‡IDã§ã™ã€‚<br>
      ãƒ¬ã‚¸ã«ã¦ã‚¹ã‚­ãƒ£ãƒ³å¾Œã€ã‚¹ã‚¿ãƒƒãƒ•ãŒå†…å®¹ã‚’ç¢ºèªã—å•†å“ã‚’ã”ç”¨æ„ã„ãŸã—ã¾ã™ã€‚<br>
      ãã®å¾Œã«ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
    </div>
    <button class="btn-secondary" onclick="clearCart()">æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹</button>
  </div>
</div>

<nav class="bottom-nav">
  <button class="nav-item active" id="nav-top" onclick="navigate('top')"><div class="nav-icon">ğŸ </div><div>TOP</div></button>
  <button class="nav-item" id="nav-products" onclick="navigate('products')"><div class="nav-icon">ğŸ›</div><div>å•†å“</div></button>
  <button class="nav-item" id="nav-cart" onclick="navigate('cart')">
    <div class="nav-icon">ğŸ›’</div>
    <div class="cart-badge" id="cart-badge">0</div>
    <div>ã‚«ãƒ¼ãƒˆ</div>
  </button>
  <button class="nav-item" id="nav-qr" onclick="navigate('qr')"><div class="nav-icon">ğŸ“±</div><div>QR</div></button>
</nav>

<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-img" id="modal-img"></div>
    <div class="modal-name" id="modal-name"></div>
    <div class="modal-price" id="modal-price"></div>
    <div class="modal-desc" id="modal-desc"></div>
    <div class="modal-qty">
      <button class="modal-qty-btn" onclick="changeModalQty(-1)">âˆ’</button>
      <div class="modal-qty-num" id="modal-qty">1</div>
      <button class="modal-qty-btn" onclick="changeModalQty(1)">ï¼‹</button>
    </div>
    <button class="btn-primary" onclick="addToCartFromModal()">ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã™ã‚‹</button>
  </div>
</div>

<script>
// ============================================================
// PRODUCTS
// ============================================================
const PRODUCTS = [
  { id: 1,  name: "ãƒ„ã‚¢ãƒ¼Tã‚·ãƒ£ãƒ„ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆï¼‰", price: 3800, category: "è¡£é¡",  emoji: "ğŸ‘•", desc: "ãƒ„ã‚¢ãƒ¼ãƒ­ã‚´å…¥ã‚ŠTã‚·ãƒ£ãƒ„ã€‚ã‚µã‚¤ã‚ºã¯Sãƒ»Mãƒ»Lãƒ»XLã‚’ã”ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚", soldOut: false },
  { id: 2,  name: "ãƒ„ã‚¢ãƒ¼Tã‚·ãƒ£ãƒ„ï¼ˆãƒ–ãƒ©ãƒƒã‚¯ï¼‰", price: 3800, category: "è¡£é¡",  emoji: "ğŸ–¤", desc: "ãƒ–ãƒ©ãƒƒã‚¯ã‚«ãƒ©ãƒ¼ã®ãƒ„ã‚¢ãƒ¼Tã‚·ãƒ£ãƒ„ã€‚", soldOut: false },
  { id: 3,  name: "ãƒ•ã‚©ãƒˆãƒ–ãƒƒã‚¯",               price: 2500, category: "æ›¸ç±",  emoji: "ğŸ“–", desc: "ãƒ„ã‚¢ãƒ¼å…¬å¼ãƒ•ã‚©ãƒˆãƒ–ãƒƒã‚¯ã€‚å…¨128ãƒšãƒ¼ã‚¸ã€‚", soldOut: false },
  { id: 4,  name: "ã‚¿ã‚ªãƒ«",                     price: 1500, category: "é›‘è²¨",  emoji: "ğŸ§£", desc: "å…¬å¼ã‚¿ã‚ªãƒ«ã€‚ã‚µã‚¤ã‚º34Ã—110cmã€‚", soldOut: false },
  { id: 5,  name: "ã‚¢ã‚¯ãƒªãƒ«ã‚¹ã‚¿ãƒ³ãƒ‰",           price: 2000, category: "ã‚°ãƒƒã‚º", emoji: "âœ¨", desc: "ãƒ¡ãƒ³ãƒãƒ¼å…¨ç¨®ã€‚ãƒ©ãƒ³ãƒ€ãƒ è²©å£²ã€‚", soldOut: false },
  { id: 6,  name: "ãƒ©ãƒ³ãƒ€ãƒ ç¼¶ãƒãƒƒã‚¸",           price: 500,  category: "ã‚°ãƒƒã‚º", emoji: "ğŸ–", desc: "ãƒ¡ãƒ³ãƒãƒ¼å…¨ç¨®ã€‚ãƒ©ãƒ³ãƒ€ãƒ è²©å£²ã€‚", soldOut: false },
  { id: 7,  name: "ãƒšãƒ³ãƒ©ã‚¤ãƒˆ",                 price: 2800, category: "ã‚°ãƒƒã‚º", emoji: "ğŸ’¡", desc: "å…¬å¼ãƒšãƒ³ãƒ©ã‚¤ãƒˆã€‚å……é›»å¼ã€‚", soldOut: false },
  { id: 8,  name: "ãƒ‘ãƒ¼ã‚«ãƒ¼",                   price: 6500, category: "è¡£é¡",  emoji: "ğŸ§¥", desc: "ãƒ•ãƒ«ã‚¸ãƒƒãƒ—ãƒ‘ãƒ¼ã‚«ãƒ¼ã€‚å‰é¢ãƒ»èƒŒé¢ãƒ­ã‚´å…¥ã‚Šã€‚", soldOut: true },
  { id: 9,  name: "ã‚¯ãƒªã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚»ãƒƒãƒˆ",       price: 1200, category: "æ›¸ç±",  emoji: "ğŸ“", desc: "A4ã‚¯ãƒªã‚¢ãƒ•ã‚¡ã‚¤ãƒ«5æšã‚»ãƒƒãƒˆã€‚", soldOut: false },
  { id: 10, name: "ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼",               price: 800,  category: "é›‘è²¨",  emoji: "ğŸ”‘", desc: "é‡‘å±è£½ãƒ„ã‚¢ãƒ¼ãƒ­ã‚´ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ã€‚", soldOut: false },
];

// ============================================================
// XSSã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆ#4 å¯¾å‡¦ï¼‰
// innerHTML ã«å‹•çš„ãªæ–‡å­—åˆ—ã‚’å…¥ã‚Œã‚‹ç®‡æ‰€ã§ä½¿ç”¨
// ============================================================
function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// ============================================================
// ã‚«ãƒ¼ãƒˆå¾©å…ƒï¼šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼ˆ#7 å¯¾å‡¦ï¼‰
// - id ãŒ PRODUCTS ã«å­˜åœ¨ã™ã‚‹ã“ã¨
// - qty ãŒæ•´æ•°ã‹ã¤ 1ã€œ10 ã®ç¯„å›²ã§ã‚ã‚‹ã“ã¨
// - ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã¯ç„¡è¦–ã—ã¦ç©ºã‚«ãƒ¼ãƒˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
// ============================================================
function loadCart() {
  try {
    const raw = JSON.parse(localStorage.getItem('mo_nog41') || '[]');
    if (!Array.isArray(raw)) return [];
    return raw.filter(c =>
      typeof c === 'object' && c !== null &&
      PRODUCTS.some(p => p.id === c.id) &&
      Number.isInteger(c.qty) && c.qty >= 1 && c.qty <= 10
    );
  } catch {
    return [];
  }
}

// ============================================================
// STATE
// ============================================================
let cart = loadCart();
let currentCategory = 'ã™ã¹ã¦';
let modalProduct = null;
let modalQty = 1;

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  renderCategories();
  renderProducts();
  updateCartUI();
});

// ============================================================
// NAVIGATION
// ============================================================
function navigate(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.getElementById('nav-' + page).classList.add('active');
  if (page === 'qr') renderQR();
  if (page === 'cart') renderCart();
  window.scrollTo(0, 0);
}

// ============================================================
// PRODUCTS
// ============================================================
function renderCategories() {
  const cats = ['ã™ã¹ã¦', ...new Set(PRODUCTS.map(p => p.category))];
  // ã‚«ãƒ†ã‚´ãƒªåã¯å›ºå®šå€¤ãªã®ã§ innerHTML ã§ã‚‚å®‰å…¨ã ãŒã€escHtml ã‚’é€šã™
  document.getElementById('category-tabs').innerHTML = cats.map(cat =>
    `<div class="cat-tab ${cat === currentCategory ? 'active' : ''}" onclick="selectCategory('${escHtml(cat)}')">${escHtml(cat)}</div>`
  ).join('');
}

function selectCategory(cat) { currentCategory = cat; renderCategories(); renderProducts(); }
function filterProducts() { renderProducts(); }

function renderProducts() {
  const q = (document.getElementById('search-input')?.value || '').toLowerCase();
  const products = PRODUCTS.filter(p =>
    (currentCategory === 'ã™ã¹ã¦' || p.category === currentCategory) &&
    (!q || p.name.toLowerCase().includes(q))
  );
  // å•†å“åãƒ»ä¾¡æ ¼ã¯ escHtml ã§ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆ#4 å¯¾å‡¦ï¼‰
  document.getElementById('product-grid').innerHTML = products.map(p => {
    const inCart = cart.find(c => c.id === p.id);
    return `
      <div class="product-card" onclick="openModal(${p.id})">
        <div class="product-img">
          <span>${p.emoji}</span>
          ${p.soldOut ? '<div class="sold-out-overlay">SOLD OUT</div>' : ''}
          ${inCart ? `<div class="in-cart-indicator" style="display:flex;">Ã—${inCart.qty}</div>` : ''}
        </div>
        <div class="product-info">
          <div class="product-name">${escHtml(p.name)}</div>
          <div class="product-price">Â¥${p.price.toLocaleString()}<span>ç¨è¾¼</span></div>
        </div>
        ${!p.soldOut ? `<button class="add-btn" onclick="quickAdd(event,${p.id})">+</button>` : ''}
      </div>`;
  }).join('');
}

function quickAdd(e, id) { e.stopPropagation(); addToCart(id, 1); }

// ============================================================
// MODAL â€” textContent ã§å®‰å…¨ã«æŒ¿å…¥
// ============================================================
function openModal(id) {
  const p = PRODUCTS.find(x => x.id === id); if (!p) return;
  modalProduct = p; modalQty = 1;
  document.getElementById('modal-img').textContent   = p.emoji;
  document.getElementById('modal-name').textContent  = p.name;
  document.getElementById('modal-price').textContent = `Â¥${p.price.toLocaleString()} (ç¨è¾¼)`;
  document.getElementById('modal-desc').textContent  = p.desc;
  document.getElementById('modal-qty').textContent   = modalQty;
  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal(e) {
  if (e.target === document.getElementById('modal-overlay'))
    document.getElementById('modal-overlay').classList.remove('open');
}

function changeModalQty(d) {
  modalQty = Math.max(1, Math.min(10, modalQty + d));
  document.getElementById('modal-qty').textContent = modalQty;
}

function addToCartFromModal() {
  if (!modalProduct) return;
  addToCart(modalProduct.id, modalQty);
  document.getElementById('modal-overlay').classList.remove('open');
}

// ============================================================
// CART
// ============================================================
function addToCart(id, qty) {
  const p = PRODUCTS.find(x => x.id === id); if (!p || p.soldOut) return;
  const existing = cart.find(c => c.id === id);
  if (existing) existing.qty = Math.min(existing.qty + qty, 10);
  else cart.push({ id: p.id, qty });
  saveCart(); showToast('ğŸ›’ ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ'); renderProducts();
}

function saveCart() { localStorage.setItem('mo_nog41', JSON.stringify(cart)); updateCartUI(); }

function updateCartUI() {
  const total = cart.reduce((s, c) => s + c.qty, 0);
  const badge = document.getElementById('cart-badge');
  badge.style.display = total > 0 ? 'flex' : 'none';
  badge.textContent = total > 9 ? '9+' : total;
}

function renderCart() {
  const empty = document.getElementById('cart-empty');
  const content = document.getElementById('cart-content');
  if (cart.length === 0) { empty.style.display = 'block'; content.style.display = 'none'; return; }
  empty.style.display = 'none'; content.style.display = 'block';

  document.getElementById('cart-items').innerHTML = cart.map(c => {
    const p = PRODUCTS.find(x => x.id === c.id); if (!p) return '';
    return `
      <div class="cart-item">
        <div class="cart-item-img">${p.emoji}</div>
        <div class="cart-item-info">
          <div class="cart-item-name">${escHtml(p.name)}</div>
          <div class="cart-item-price">Â¥${p.price.toLocaleString()}</div>
          <div class="qty-control">
            <button class="qty-btn" onclick="updateQty(${p.id},-1)">âˆ’</button>
            <div class="qty-num">${c.qty}</div>
            <button class="qty-btn" onclick="updateQty(${p.id},1)">ï¼‹</button>
          </div>
        </div>
        <button class="delete-btn" onclick="removeItem(${p.id})">ğŸ—‘</button>
      </div>`;
  }).join('');

  const total = cart.reduce((s, c) => { const p = PRODUCTS.find(x => x.id === c.id); return s + (p ? p.price * c.qty : 0); }, 0);
  document.getElementById('subtotal').textContent     = `Â¥${total.toLocaleString()}`;
  document.getElementById('total-amount').textContent = `Â¥${total.toLocaleString()}`;
}

function updateQty(id, d) {
  const item = cart.find(c => c.id === id); if (!item) return;
  item.qty += d;
  if (item.qty <= 0) cart = cart.filter(c => c.id !== id);
  saveCart(); renderCart(); renderProducts();
}

function removeItem(id) { cart = cart.filter(c => c.id !== id); saveCart(); renderCart(); renderProducts(); }

function clearCart() {
  if (!confirm('æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  cart = []; saveCart(); renderProducts(); navigate('top');
}

// ============================================================
// QR CODEï¼ˆ#6 å¯¾å‡¦ï¼‰
// æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ Firebase ã«ä¿å­˜ã—ã€orderId ã ã‘ã‚’ QR ã«åŸ‹ã‚è¾¼ã‚€
// Firebase æœªè¨­å®šæ™‚ã¯ orderId ã®ã¿ã‚’åŸ‹ã‚è¾¼ã‚€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œ
// ============================================================
async function renderQR() {
  const empty   = document.getElementById('qr-empty');
  const content = document.getElementById('qr-content');
  if (cart.length === 0) { empty.style.display = 'block'; content.style.display = 'none'; return; }
  empty.style.display = 'none'; content.style.display = 'block';

  const total = cart.reduce((s, c) => {
    const p = PRODUCTS.find(x => x.id === c.id);
    return s + (p ? p.price * c.qty : 0);
  }, 0);

  const orderData = {
    total,
    items: cart.map(c => {
      const p = PRODUCTS.find(x => x.id === c.id);
      return { id: c.id, name: p?.name, qty: c.qty, price: p?.price };
    })
  };

  // Firebase ã«æ³¨æ–‡ã‚’ä¿å­˜ã—ã¦ orderId ã‚’å–å¾—
  let orderId = null;
  const savingEl = document.getElementById('qr-saving');

  if (typeof window.saveOrderToFirebase === 'function') {
    savingEl.style.display = 'flex';
    orderId = await window.saveOrderToFirebase(orderData);
    savingEl.style.display = 'none';
  }

  // Firebase æœªè¨­å®šæ™‚ã¯æ—¥æ™‚ãƒ™ãƒ¼ã‚¹ã® ID ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ä½¿ç”¨
  if (!orderId) {
    orderId = 'LOCAL-' + Date.now().toString(36).toUpperCase();
  }

  document.getElementById('qr-order-id').textContent  = orderId;
  document.getElementById('qr-total-num').textContent = total.toLocaleString();

  // QR ã«ã¯ orderId ã®ã¿åŸ‹ã‚è¾¼ã‚€ï¼ˆæ³¨æ–‡å†…å®¹ã¯ Firebase ä¸Šã§ç®¡ç†ï¼‰
  const qrContainer = document.getElementById('qr-container');
  qrContainer.innerHTML = '';
  new QRCode(qrContainer, {
    text: orderId,  // â† orderId ã®ã¿ã€‚å†…å®¹ã¯ Firebase ã§ç…§åˆ
    width: 168, height: 168,
    colorDark: "#1a1714", colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.M
  });
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}
</script>
</body>
</html>
